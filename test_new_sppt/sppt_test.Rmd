---
title: "Test of Wouter's implementation of SPPT"
author: "Nick Malleson"
date: "17/8/2017"
output:
  html_document: 
    toc: yes
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
  pdf_document:
    fig_crop: no
    highlight: kate
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
fontsize: 10pt
---

# Initialise

```{r init}
# The working directory
WORKING_DIR <- '~/research_not_syncd/git_projects/spatialtest/test'

library(GISTools)
library(rgdal)     # For reading shapefiles
library(leaflet) # For doing interactive maps
library(sppt)


# Define British National Grid and WGS projections
BNG <- CRS('+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs')
WGS <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84")

```

# Prepare London crime data

The raw data represent all offences that were recorded by the Metropolitan Police Service in London, UK, in April 2017 and May 2017. They are publicly available from [data.police.uk](https://data.police.uk/data/).



The boundary data represent Lower Super Output Areas in Greater London, downloaded from [UKBORDERS](https://borders.ukdataservice.ac.uk/).

```{r prepData }

# Read the csv files
crime1.txt <- read.csv(file="./data/2017-05-metropolitan-street.csv")
crime2.txt <- read.csv(file="./data/2017-04-metropolitan-street.csv")

# Drop rows with NAs in coordinates
crime1.txt <- crime1.txt[which(!(is.na(crime1.txt$Longitude) | is.na(crime1.txt$Latitude) )), ]
crime2.txt <- crime1.txt[which(!(is.na(crime2.txt$Longitude) | is.na(crime2.txt$Latitude) )), ]

# Create SpatialPoints
crime1 <- SpatialPointsDataFrame(coords = crime1.txt[,c("Longitude","Latitude")], data = crime1.txt, proj4string = WGS)
crime2 <- SpatialPointsDataFrame(coords = crime2.txt[,c("Longitude","Latitude")], data = crime2.txt, proj4string = WGS)

# Read the areas and reproject
areas.bng <- readOGR(dsn="./data", layer="london_lsoa")
areas <- spTransform(areas.bng, WGS)
writeOGR(areas, dsn="./data", layer="areas", driver="ESRI Shapefile", overwrite_layer=TRUE) # This is needed for the Java version

# Write shapefiles for the crime data so that they can be read by Java
writeOGR(crime1, dsn="./data", layer="crime1", driver="ESRI Shapefile", overwrite_layer = TRUE)
writeOGR(crime2, dsn="./data", layer="crime2", driver="ESRI Shapefile", overwrite_layer = TRUE)

# Map them to make sure they look OK
plot(areas, lwd=0.5)
points(crime1)
points(crime2, col="red")


```

Also do an interactive map because it's cool

```{r interactiveMap }

m <- leaflet() %>%
  addCircleMarkers(data = crime1, fillColor="green", fillOpacity = 1, radius=1 )%>% 
  addCircleMarkers(data = crime2, fillColor="blue",  fillOpacity = 1, radius=1 ) %>%
  addProviderTiles("OpenStreetMap.HOT")
  #addProviderTiles("CartoDB.Positron")

# Uncomment the line below to display the map (not at the moment because it's very slow)
#m

```

# Test with London crime data


```{r testSppt}

result.r <- sppt(
  base_points.sp = crime1, 
  test_points.sp = crime2, 
  uoa.sp = areas,
  nsamples = 100,
  )

# Write that out
writeOGR(result.r, dsn="./data", layer="result-r", driver="ESRI Shapefile", overwrite_layer = TRUE)

```


# After that, check the results from Java and R with a Choropleth map and some statistics

```{r checkResults, fig.width=11, fig.height=7 }

result.java <- readOGR(dsn="./data", layer="result-java" )

stopifnot(nrow(result.java) == nrow(result.r))

# Shading for the map
shades <- shading(
  breaks = c(-0.1,0.1,1.1),
  cols=brewer.pal(3,'Set3') 
  )

par(mfrow=c(1,2))

choropleth(result.r, v=result.r$localS, shading = shades, lty=0)
title("Local S Index (r)")
choro.legend("topleft", sh = shades)

choropleth(result.java, v=result.java$SIndex, shading = shades, lty=0)
title("Local S Index (java)")
choro.legend("topleft", sh = shades)


```

Check which areas are different:

```{r checkDifferent}

different <- which(result.r$localS != result.java$SIndex)

if (length(different) > 0) {
  print("There are some differences")
  par(mfrow=c(1,1))
  plot(result.r[different,], main="Areas with different S Index values")
} else {
  print("There are no differences")
}

```


